name: Build photos.txt

on:
  push:
    branches: ["main", "master"]
    paths:
      - "lakida/uploads/**"
      - ".github/workflows/build-photos.yml"

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Generate lakida/photos.txt
        run: |
          python3 - << 'PY'
          import os

          LAKIDA = "lakida"
          UPLOADS = os.path.join(LAKIDA, "uploads")
          OUTFILE = os.path.join(LAKIDA, "photos.txt")
          EXTS = {".jpg", ".jpeg", ".png", ".gif", ".webp", ".heic"}

          if not os.path.isdir(UPLOADS):
              raise SystemExit(f"Missing folder: {UPLOADS}")

          paths = []
          for dirpath, _, filenames in os.walk(UPLOADS):
              for name in filenames:
                  ext = os.path.splitext(name)[1].lower()
                  if ext in EXTS:
                      full = os.path.join(dirpath, name)
                      rel = os.path.relpath(full, LAKIDA).replace("\\", "/")
                      paths.append(rel)

          # sort so date folders stay grouped
          paths.sort()

          with open(OUTFILE, "w", encoding="utf-8") as f:
              for p in paths:
                  f.write(p + ";\n")

          print(f"Wrote {len(paths)} entries to {OUTFILE}")
          PY

      - name: Commit and push photos.txt
        run: |
          if git diff --quiet; then
            echo "No changes to commit."
            exit 0
          fi
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add lakida/photos.txt
          git commit -m "Auto-update lakida/photos.txt"
          git push
